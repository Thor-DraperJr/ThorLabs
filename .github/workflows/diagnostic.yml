name: ThorLabs Simple Test

on:
  workflow_dispatch:  # Manual trigger only (no inputs to avoid GitHub issues)

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: |
          az account set --subscription "$AZURE_SUBSCRIPTION_ID"
          echo "âœ… Successfully connected to Azure"

      - name: ğŸ” Check Files and Environment
        run: |
          echo "ğŸ“ Repository structure:"
          ls -la
          echo ""
          echo "ï¿½ Infra directory:"
          ls -la infra/
          echo ""
          echo "ï¿½ Azure CLI version:"
          az version --output table
          echo ""
          echo "ï¿½ Current subscription:"
          az account show --output table

      - name: ğŸ§ª Test Basic Bicep Compilation
        run: |
          echo "ğŸ”§ Testing lab.bicep compilation..."
          if [ -f "infra/lab.bicep" ]; then
            az bicep build --file infra/lab.bicep --stdout > /dev/null
            echo "âœ… Lab template compiled successfully"
          else
            echo "âŒ Lab template not found"
            exit 1
          fi

      - name: ğŸ—ï¸ Test Resource Group Creation
        run: |
          echo "ğŸ—ï¸ Testing resource group creation..."
          az group create \
            --name thorlabs-test-rg \
            --location eastus2 \
            --tags Environment=Test Project=ThorLabs
          echo "âœ… Test resource group created"

      - name: ğŸ§ª Test Template Validation (Basic)
        run: |
          echo "ğŸ–¥ï¸ Testing basic template validation..."
          # Use what-if instead of validate to avoid Azure CLI response consumption issue
          az deployment group what-if \
            --resource-group thorlabs-test-rg \
            --template-file infra/lab.bicep \
            --parameters @infra/lab.parameters.json adminPassword="$ADMIN_PASSWORD" \
            --result-format ResourceIdOnly \
            --no-pretty-print
          echo "âœ… Template validation passed"

      - name: ï¿½ Cleanup Test Resources
        run: |
          echo "ğŸ§¹ Cleaning up test resources..."
          az group delete --name thorlabs-test-rg --yes --no-wait
          echo "âœ… Cleanup initiated"

      - name: ğŸ‰ Test Complete
        run: |
          echo "ğŸ‰ All tests passed successfully!"
          echo "Your Azure connection and templates are working correctly."
