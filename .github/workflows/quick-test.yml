name: ThorLabs Quick Test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: |
          az account set --subscription "$AZURE_SUBSCRIPTION_ID"
          echo "✅ Successfully connected to Azure"

      - name: 🧪 Test Bicep Compilation
        run: |
          echo "🔧 Testing Bicep templates compilation..."
          
          # Test lab.bicep
          if [ -f "infra/lab.bicep" ]; then
            echo "Compiling lab.bicep..."
            az bicep build --file infra/lab.bicep --stdout > /dev/null
            echo "✅ lab.bicep compiled successfully"
          fi
          
          # Test sentinel.bicep
          if [ -f "infra/thorlabs-sentinel.bicep" ]; then
            echo "Compiling thorlabs-sentinel.bicep..."
            az bicep build --file infra/thorlabs-sentinel.bicep --stdout > /dev/null
            echo "✅ thorlabs-sentinel.bicep compiled successfully"
          fi
          
          echo "🎉 All Bicep templates compile successfully!"

      - name: 🏗️ Test Resource Group Operations
        run: |
          echo "🏗️ Testing resource group operations..."
          
          # Create test resource group
          az group create \
            --name thorlabs-test-rg \
            --location eastus2 \
            --tags Environment=Test Project=ThorLabs
          echo "✅ Test resource group created"
          
          # Clean up test resource group
          echo "🧹 Cleaning up test resource group..."
          az group delete --name thorlabs-test-rg --yes --no-wait
          echo "✅ Cleanup initiated"

      - name: 🎉 Success Summary
        run: |
          echo "🎉 All tests passed successfully!"
          echo ""
          echo "✅ Azure connection working"
          echo "✅ Bicep templates compile correctly" 
          echo "✅ Resource group operations working"
          echo ""
          echo "🚀 Your ThorLabs environment is ready for deployment!"
