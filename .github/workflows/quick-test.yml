name: ThorLabs Quick Test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: |
          az account set --subscription "$AZURE_SUBSCRIPTION_ID"
          echo "âœ… Successfully connected to Azure"

      - name: ğŸ§ª Test Bicep Compilation
        run: |
          echo "ğŸ”§ Testing Bicep templates compilation..."
          
          # Test lab.bicep
          if [ -f "infra/lab.bicep" ]; then
            echo "Compiling lab.bicep..."
            az bicep build --file infra/lab.bicep --stdout > /dev/null
            echo "âœ… lab.bicep compiled successfully"
          fi
          
          # Test sentinel.bicep
          if [ -f "infra/thorlabs-sentinel.bicep" ]; then
            echo "Compiling thorlabs-sentinel.bicep..."
            az bicep build --file infra/thorlabs-sentinel.bicep --stdout > /dev/null
            echo "âœ… thorlabs-sentinel.bicep compiled successfully"
          fi
          
          echo "ğŸ‰ All Bicep templates compile successfully!"

      - name: ğŸ—ï¸ Test Resource Group Operations
        run: |
          echo "ğŸ—ï¸ Testing resource group operations..."
          
          # Create test resource group
          az group create \
            --name thorlabs-test-rg \
            --location eastus2 \
            --tags Environment=Test Project=ThorLabs
          echo "âœ… Test resource group created"
          
          # Clean up test resource group
          echo "ğŸ§¹ Cleaning up test resource group..."
          az group delete --name thorlabs-test-rg --yes --no-wait
          echo "âœ… Cleanup initiated"

      - name: ğŸ‰ Success Summary
        run: |
          echo "ğŸ‰ All tests passed successfully!"
          echo ""
          echo "âœ… Azure connection working"
          echo "âœ… Bicep templates compile correctly" 
          echo "âœ… Resource group operations working"
          echo ""
          echo "ğŸš€ Your ThorLabs environment is ready for deployment!"
