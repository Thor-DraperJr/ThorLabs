name: Quick Test ThorLabs Templates

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      test_scope:
        description: 'What to test'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'compilation'
          - 'validation'
          - 'what-if'

jobs:
  quick-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: |
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"

      - name: ğŸ”§ Quick Compilation Test
        if: ${{ github.event.inputs.test_scope == 'all' || github.event.inputs.test_scope == 'compilation' }}
        run: |
          echo "ğŸ”§ Quick Bicep compilation test..."
          for template in infra/*.bicep bicep/*.bicep; do
            if [ -f "$template" ]; then
              echo "âœ“ Testing: $template"
              az bicep build --file "$template" --stdout > /dev/null
            fi
          done
          echo "âœ… All templates compiled successfully!"

      - name: âš¡ Quick Validation Test
        if: ${{ github.event.inputs.test_scope == 'all' || github.event.inputs.test_scope == 'validation' }}
        run: |
          echo "âš¡ Quick validation test..."
          
          # Test main lab template
          echo "Testing lab.bicep..."
          az deployment group validate \
            --resource-group thorlabs-rg \
            --template-file infra/lab.bicep \
            --parameters adminPassword="TestPassword123!" \
            --parameters @infra/lab.parameters.json \
            --only-show-errors
          
          # Test Sentinel template  
          echo "Testing thorlabs-sentinel.bicep..."
          az deployment group validate \
            --resource-group thorlabs-rg \
            --template-file infra/thorlabs-sentinel.bicep \
            --parameters @infra/thorlabs-sentinel.parameters.json \
            --only-show-errors
          
          echo "âœ… Quick validation passed!"

      - name: ğŸ” What-If Preview
        if: ${{ github.event.inputs.test_scope == 'all' || github.event.inputs.test_scope == 'what-if' }}
        run: |
          echo "ğŸ” What-if analysis preview..."
          az deployment group what-if \
            --resource-group thorlabs-rg \
            --template-file infra/lab.bicep \
            --parameters adminPassword="TestPassword123!" \
            --parameters @infra/lab.parameters.json \
            --result-format ResourceIdOnly
          echo "âœ… What-if analysis completed!"

      - name: ğŸ¯ Test Summary
        run: |
          echo "ğŸ¯ Quick Test Results:"
          echo "âœ… All requested tests completed successfully!"
          echo ""
          echo "ğŸ“‹ Tested components:"
          case "${{ github.event.inputs.test_scope }}" in
            "all")
              echo "  âœ“ Bicep template compilation"
              echo "  âœ“ Azure deployment validation"
              echo "  âœ“ What-if analysis preview"
              ;;
            "compilation")
              echo "  âœ“ Bicep template compilation"
              ;;
            "validation")
              echo "  âœ“ Azure deployment validation"
              ;;
            "what-if")
              echo "  âœ“ What-if analysis preview"
              ;;
          esac
          echo ""
          echo "ğŸš€ Ready for deployment via main workflow!"
