name: ThorLabs Deploy v2

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'What to do?'
        required: true
        default: 'validate'
        type: choice
        options:
          - 'validate'
          - 'deploy'
          - 'clean-deploy'

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Azure Subscription
        run: |
          az account set --subscription "$AZURE_SUBSCRIPTION_ID"

      - name: ğŸ—ï¸ Ensure Resource Group Exists
        run: |
          echo "ğŸ—ï¸ Ensuring resource group exists..."
          az group create --name thorlabs-rg --location eastus2 --tags Environment=Lab Project=ThorLabs AutoShutdown_Time=19:00 || echo "Resource group already exists"

      # VALIDATION STEPS
      - name: ğŸ§ª Compile Templates
        run: |
          echo "ğŸ”§ Compiling Bicep templates..."
          for template in infra/*.bicep; do
            if [ -f "$template" ]; then
              echo "Compiling: $template"
              az bicep build --file "$template" --stdout > /dev/null
              echo "âœ… $(basename $template) compiled"
            fi
          done

      - name: ğŸ§ª Validate Lab Template
        run: |
          echo "ğŸ–¥ï¸ Validating lab template..."
          az deployment group validate \
            --resource-group thorlabs-rg \
            --template-file infra/lab.bicep \
            --parameters @infra/lab.parameters.json adminPassword="$ADMIN_PASSWORD"
          echo "âœ… Lab template validated"

      - name: ğŸ§ª Validate Sentinel Template
        run: |
          echo "ğŸ›¡ï¸ Validating Sentinel template..."
          if [ -f "infra/thorlabs-sentinel.bicep" ]; then
            az deployment group validate \
              --resource-group thorlabs-rg \
              --template-file infra/thorlabs-sentinel.bicep \
              --parameters @infra/thorlabs-sentinel.parameters.json
            echo "âœ… Sentinel template validated"
          fi

      # DEPLOYMENT STEPS (only if not validation-only)
      - name: ğŸ—‘ï¸ Clean Deploy (if requested)
        if: ${{ github.event.inputs.action == 'clean-deploy' }}
        run: |
          echo "ğŸ—‘ï¸ Deleting resource group for clean deployment..."
          az group delete --name thorlabs-rg --yes --no-wait || echo "Resource group doesn't exist"
          echo "â³ Waiting for deletion to complete..."
          while az group show --name thorlabs-rg --output none 2>/dev/null; do
            echo "Still deleting..."
            sleep 30
          done
          echo "âœ… Clean slate ready"
          
          echo "ğŸ—ï¸ Recreating resource group..."
          az group create --name thorlabs-rg --location eastus2 --tags Environment=Lab Project=ThorLabs AutoShutdown_Time=19:00

      - name: ğŸš€ Deploy Lab Environment
        if: ${{ github.event.inputs.action == 'deploy' || github.event.inputs.action == 'clean-deploy' }}
        run: |
          echo "ğŸš€ Deploying lab environment..."
          DEPLOYMENT_NAME="thorlabs-$(date +%Y%m%d-%H%M%S)"
          
          az deployment group create \
            --name "$DEPLOYMENT_NAME" \
            --resource-group thorlabs-rg \
            --template-file infra/lab.bicep \
            --parameters @infra/lab.parameters.json adminPassword="$ADMIN_PASSWORD"
          
          echo "âœ… Lab environment deployed"

      - name: ğŸ›¡ï¸ Deploy Sentinel
        if: ${{ github.event.inputs.action == 'deploy' || github.event.inputs.action == 'clean-deploy' }}
        run: |
          echo "ğŸ›¡ï¸ Deploying Sentinel SOC..."
          if [ -f "infra/thorlabs-sentinel.bicep" ]; then
            SENTINEL_NAME="sentinel-$(date +%Y%m%d-%H%M%S)"
            
            az deployment group create \
              --name "$SENTINEL_NAME" \
              --resource-group thorlabs-rg \
              --template-file infra/thorlabs-sentinel.bicep \
              --parameters @infra/thorlabs-sentinel.parameters.json
            
            echo "âœ… Sentinel deployed"
          fi

      - name: ğŸ‰ Summary
        run: |
          echo "ğŸ‰ Action '${{ github.event.inputs.action }}' completed successfully!"
          
          if [ "${{ github.event.inputs.action }}" != "validate" ]; then
            echo ""
            echo "ğŸ”— Azure Portal: https://portal.azure.com/#@/resource/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/thorlabs-rg"
            echo "ğŸ›¡ï¸ Sentinel: https://portal.azure.com/#blade/Microsoft_Azure_Security_Insights/MainMenuBlade"
          fi
